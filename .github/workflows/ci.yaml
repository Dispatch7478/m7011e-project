name: Build, Push, and Update Image Tag

on:
  push:
    branches: [ "main" ]
    paths:
      - 'services/**'
      - 'frontend/**'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.set_image_name.outputs.lowercase_image_name }}
    steps:
      - name: Set image name to lowercase
        id: set_image_name
        run: echo "lowercase_image_name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

  # NEW JOB: Runs Unit Tests for Go Services
  test:
    name: Run Go Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22' 

      - name: Run Tests
        run: |
          # Iterate through all directories in services/
          for dir in services/*/; do
            # Only run if directory contains a go.mod file
            if [ -f "$dir/go.mod" ]; then
              service_name=$(basename "$dir")
              echo "ðŸ§ª Testing $service_name..."
              
              cd "$dir"
              go test -v ./...
              
              # Exit immediately if a test fails
              if [ $? -ne 0 ]; then
                echo "âŒ Tests failed for $service_name"
                exit 1
              fi
              
              cd - > /dev/null
            fi
          done
          echo "âœ… All Go services passed testing."

  build-and-push:
    # MODIFIED: Now waits for 'test' to succeed
    needs: [prepare, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            services/**
            frontend/**

      - name: Build and push changed components
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          declare -A services_to_build
          build_frontend="false"

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" == services/* ]]; then
              service_name=$(echo "$file" | cut -d/ -f2)
              services_to_build[$service_name]=1
            elif [[ "$file" == frontend/* ]]; then
              build_frontend="true"
            fi
          done

          # 1. Build Backend Services
          for service_name in "${!services_to_build[@]}"; do
            echo "Building and pushing service: $service_name"
            
            docker build -t ghcr.io/${{ needs.prepare.outputs.image_name }}/$service_name:${{ github.sha }} ./services/$service_name
            docker push ghcr.io/${{ needs.prepare.outputs.image_name }}/$service_name:${{ github.sha }}
            
            yq -i ".image.tag = \"${{ github.sha }}\"" k8s/charts/$service_name/values.yaml
          done

          # 2. Build Frontend
          if [[ "$build_frontend" == "true" ]]; then
            echo "Building and pushing Frontend"
            
            docker build -t ghcr.io/${{ needs.prepare.outputs.image_name }}/frontend:${{ github.sha }} ./frontend
            docker push ghcr.io/${{ needs.prepare.outputs.image_name }}/frontend:${{ github.sha }}
            
            yq -i ".image.tag = \"${{ github.sha }}\"" k8s/charts/frontend/values.yaml
          fi

      - name: Commit and push updated values.yaml
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ci: update image tags [skip ci]"
          file_pattern: "k8s/charts/**/values.yaml"
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions <actions@github.com>"