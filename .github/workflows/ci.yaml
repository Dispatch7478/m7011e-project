name: Build, Push, and Update Image Tag

on:
  push:
    branches: [ "main" ]
    paths:
      - 'services/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Force repository name to lowercase
        run: |
          echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "REGISTRY=ghcr.io" >> $GITHUB_ENV

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: services/**

      - name: Build and push changed services
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" == services/* ]]; then
              service_name=$(echo "$file" | cut -d/ -f2)
              echo "Building and pushing $service_name"
              
              # FIX: Use bash variables ($VAR) instead of Actions context (${{ env.VAR }})
              # This ensures we use the lowercased version set in the previous step
              docker build -t $REGISTRY/$IMAGE_NAME/$service_name:${{ github.sha }} ./services/$service_name
              docker push $REGISTRY/$IMAGE_NAME/$service_name:${{ github.sha }}
              
              # Update the image tag in the corresponding values.yaml file
              yq -i ".image.tag = \"${{ github.sha }}\"" k8s/charts/$service_name/values.yaml
            fi
          done

      - name: Commit and push updated values.yaml
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ci: update image tags"
          file_pattern: "k8s/charts/**/values.yaml"
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions <actions@github.com>"