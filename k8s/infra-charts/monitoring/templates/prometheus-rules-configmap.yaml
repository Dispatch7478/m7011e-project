apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-prometheus-rules
  labels:
    app: prometheus
    release: {{ .Release.Name }}
data:
  team-service.rules.yml: |
    groups:
      - name: team-service
        rules:
          - alert: TeamServiceDown
            expr: up{job="team-service"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "team-service is down"

          - alert: TeamServiceHigh5xxRate
            expr: |
              (
                sum(rate(teamservice_http_requests_total{job="team-service", code=~"5.."}[5m]))
              /
                sum(rate(teamservice_http_requests_total{job="team-service"}[5m]))
              ) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "team-service 5xx rate > 5%"

          - alert: TeamServiceHighLatencyP95
            expr: |
              histogram_quantile(
                0.95,
                sum(rate(teamservice_http_request_duration_seconds_bucket{job="team-service"}[5m])) by (le)
              ) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "team-service p95 latency > 1s"
  bracket-service.rules.yml: |
    groups:
      - name: bracket-service
        rules:
          - alert: BracketServiceDown
            expr: up{job="bracket-service"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "bracket-service is down"

          - alert: BracketServiceHigh5xxRate
            expr: |
              (
                sum(rate(bracketservice_http_requests_total{job="bracket-service",code=~"5.."}[5m]))
              /
                sum(rate(bracketservice_http_requests_total{job="bracket-service"}[5m]))
              ) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "bracket-service 5xx rate > 5%"

          - alert: BracketServiceHighLatencyP95
            expr: |
              histogram_quantile(
                0.95,
                sum(rate(bracketservice_http_request_duration_seconds_bucket{job="bracket-service"}[5m])) by (le)
              ) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "bracket-service p95 latency > 1s"
  tournament-service.rules.yml: |
    groups:
      - name: tournament-service
        rules:
          - alert: TournamentServiceDown
            expr: up{job="tournament-service"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "tournament-service is down"

          - alert: TournamentServiceHigh5xxRate
            expr: |
              (
                sum(rate(tournamentservice_http_requests_total{job="tournament-service",code=~"5.."}[5m]))
              /
                sum(rate(tournamentservice_http_requests_total{job="tournament-service"}[5m]))
              ) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "tournament-service 5xx rate > 5%"

          - alert: TournamentServiceHighLatencyP95
            expr: |
              histogram_quantile(
                0.95,
                sum(rate(tournamentservice_http_request_duration_seconds_bucket{job="tournament-service"}[5m])) by (le)
              ) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "tournament-service p95 latency > 1s"
  user-service.rules.yml: |
    groups:
      - name: user-service
        rules:
          - alert: UserServiceDown
            expr: up{job="user-service"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "user-service is down"

          - alert: UserServiceHigh5xxRate
            expr: |
              (
                sum(rate(user-service_http_requests_total{job="user-service",code=~"5.."}[5m]))
              /
                sum(rate(user-service_http_requests_total{job="user-service"}[5m]))
              ) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "user-service 5xx rate > 5%"

          - alert: UserServiceHighLatencyP95
            expr: |
              histogram_quantile(
                0.95,
                sum(rate(user-service_http_request_duration_seconds_bucket{job="user-service"}[5m])) by (le)
              ) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "user-service p95 latency > 1s"
